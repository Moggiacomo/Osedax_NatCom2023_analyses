#IMPORTANT !!!!!!! otherwise itâ€™s not working! set some path with the script /data/home/btx654/.conda/envs/Repeats_env3/share/RepeatMasker/configure. Hope now is working. I Chose RMBlast as default (n2) and I specified the path to the bin of the conda env:  /data/home/btx654/.conda/envs/Repeats_env/bin
#/data/home/btx654/.conda/envs/Repeats_env3/share/RepeatMasker/
#/data/home/btx654/.conda/envs/Repeats_env3/bin

#you have to:

#    cd /data/home/btx654/.conda/envs/Repeats_env3/share/RepeatMasker/util/
#    cp createRepeatLandscape.pl createRepeatLandscape_TEclass.pl
#    nano createRepeatLandscape_TEclass.pl #see below

#modify the script createRepeatLandscape.pl to make it work with the TEclass annotations

#    my $graphLabels = [
#                        [ 'unclear',        '#999999' ],
#                        [ 'nonLTR',         '#4D4D4D' ],
#                        [ 'DNA',            '#FF6A42' ],
#                        [ 'LTR',            '#65BD61' ],
#                        [ 'LINE',           '#251792' ],
#                        [ 'Retro',          '#FF4D4D' ],
#                        [ 'SINE',           '#9F1FF0' ],
#                        [ 'SINE/tRNA-CR1',  '#E5E5F9' ]
#    ];
    
#    my $extraChartLabels = [
#                             [ 'Simple_repeat',  '#FFFF66' ],
#                             [ 'Satellite',      '#CCCC52' ],
#                             [ 'Structural_RNA', '#99993D' ],
#                             [ 'Low_complexity', '#666629' ]
#    ];

#FIRST AND FOREMOST submit the consensi file generated with RepeatModeler to TEclass (https://www.bioinformatics.uni-muenster.de/tools/teclass/generate/index.pl?lang=en)
#!/bin/bash
#$ -wd /data/scratch/btx654/
#$ -o /data/scratch/btx654/
#$ -j y
#$ -pe smp 15
#$ -l h_vmem=15G
#$ -l h_rt=72:0:0
#$ -l highmem

genome_size=$2 #in bp
species_fasta=oasisia_purged_Nov2020.fa
species_fasta_path=/data/SBCS-MartinDuranLab/03-Giacomo/data/oasisia/haploidization/purge_dups_Nov2020/$species_fasta
species_unmasked="$1"_unmasked.fa 
species_unmasked_align="$species_unmasked".align
teclass_name=teclass_"$1".txt
teclass_path=/data/SBCS-MartinDuranLab/03-Giacomo/data/oasisia/annotation/new_annotation_Nov2020/step1/TEclass/$teclass_name
output=TEclass_"$1"
divsum="$output".divsum
html="$output".html

echo "Working on "$1

module load anaconda3
source activate Repeats_env3

cd /data/scratch/btx654/btx604-scratch/oasisia/kimura
cp /data/SBCS-MartinDuranLab/03-Giacomo/data/oasisia/annotation/new_annotation_Nov2020/step1/repeatmodeler/consensi.fa.classified ./
cp $species_fasta_path ./
mv $species_fasta $species_unmasked
cp $teclass_path ./

grep '>' $teclass_name | sed 's/|/:/g' | sed 's/#/:/' | awk  ' BEGIN { FS = ":" } ; { OFS="\t" ; print $1,$4}' > table_of_changes.tsv
grep '>' consensi.fa.classified | sed 's/|/:/g' | sed 's/#/:/' | awk  ' BEGIN { FS = ":" } ; { OFS="\t" ; print $1}' > fasta_entries
grep '>' $teclass_name | sed 's/|/:/g' | sed 's/#/:/' | awk  ' BEGIN { FS = ":" } ; { OFS="\t" ; print $1}' > text_entries

comm -13 <(sort text_entries) <(sort fasta_entries) > missing_entries

cat missing_entries | awk '{ OFS="\t" ; print $1,"unclear"}' >>table_of_changes.tsv

while read -r line
do
Target=$(echo $line | awk '{ print $1}')
rep=$(echo $line | awk '{ print $2}')
sed -iE 's/'"$Target"'#.* (/'"$Target"'#'"$rep"' (/' consensi.fa.classified
done <table_of_changes.tsv 


RepeatMasker -pa 15 -xsmall -gff -a -lib consensi.fa.classified $species_unmasked

/data/home/btx654/.conda/envs/Repeats_env3/share/RepeatMasker/util/calcDivergenceFromAlign.pl -s $divsum $species_unmasked_align
/data/home/btx654/.conda/envs/Repeats_env3/share/RepeatMasker/util/createRepeatLandscape_TEclass.pl -div $divsum  -g $genome_size > $html

# Output needs to be transformed in this format:
#Divergence unclear nonLTR DNA LTR LINE Retro SINE
#0, 0.105588793684953, 0.000852408887713364, 0.609105622097908, 0.301245162564091, 0.192945295222034, 0.0762790228888533, 0.00674240949008066
#1, 0.195798333884831, 0.00206115365283732, 0.952360420588125, 0.203462835173004, 0.706597088317784, 0.0928037743056529, 0.00608741488665695
#2, 0.239553013067509, 0.00211982096992403, 1.28776865107406, 0.182040848027999, 0.762181400760369, 0.149238391533862, 0.0136171298703843
#3, 0.242440212446584, 0.00232874593035094, 1.59374197857492, 0.225425947867172, 0.810516586421411, 0.152197749237539, 0.0162406976347026
#4, 0.203562965678327, 0.00169516365995676, 1.32048112626119, 0.192366914688814, 0.757228220670722, 0.177598098351148, 0.0226569713008941
#5, 0.182663167163678, 0.00218938010959223, 1.2959076892688, 0.173642015110552, 0.655078767507299, 0.173672957788341, 0.0284150323251719
#6, 0.148188197049725, 0.00205805938505849, 1.21811358910472, 0.170832791279504, 0.561645000281875, 0.163945074974529, 0.03293476738436
#7, 0.125620093119439, 0.00182598930164589, 1.13892174629958, 0.157589820268936, 0.512578082176494, 0.162485323207186, 0.031891380289337
#8, 0.101869236273371, 0.00159490938392252, 0.92574786112948, 0.165598899216961, 0.418848379180703, 0.144951840494486, 0.0307885832529603
#9, 0.112591369209878, 0.00202946835078206, 0.790069046085316, 0.156558810245029, 0.341318777026356, 0.140086166297624, 0.0291727566188529
#10, 0.111997393567053, 0.00243296086914209, 0.679176801198152, 0.175902439608347, 0.302986121387174, 0.146565191714371, 0.0367928242217222
#11, 0.111531644380983, 0.0029156666426403, 0.581587432345753, 0.158473543146571, 0.301030791692373, 0.142498457458004, 0.0315469264001971
#12, 0.132563134932299, 0.00459993848001556, 0.544319204822491, 0.166025413087595, 0.275572270344522, 0.1429112327797, 0.0348076657855331
#13, 0.122678063315323, 0.00358241946362358, 0.659756062681785, 0.17112637540636, 0.259884332705831, 0.138142471049672, 0.0371934700137257
#14, 0.131127518453631, 0.00140281724021247, 0.488052915761451, 0.193727278575101, 0.229879465595894, 0.128016170316658, 0.0357748101224856
#15, 0.117836400636425, 0.00154280191452695, 0.462622366594321, 0.162432844425657, 0.23138575515063, 0.119289840097499, 0.0392835860129729
#16, 0.112645580781363, 0.00126270879518684, 0.593650002084051, 0.150913875650745, 0.21305172347819, 0.11112889448689, 0.0471053998750223
#17, 0.100021463326563, 0.001054650229738, 0.440846271444705, 0.150238087567847, 0.213154329397737, 0.107550435686023, 0.058695041726003
#18, 0.0773372624692147, 0.00114525039030227, 0.421518484732415, 0.129338289053198, 0.188597477680638, 0.108332171497668, 0.0572808375803644
#19, 0.0689821206128054, 0.000925186065871555, 0.421849942696884, 0.121412136481646, 0.17996026237351, 0.100533997841449, 0.0574598100286922
#20, 0.0688069850565234, 0.000866271207362543, 0.401149043715058, 0.111468645089006, 0.163955347943555, 0.114159296578769, 0.0401444113090447
#21, 0.0604989998410636, 0.000965287776285252, 0.379029237300569, 0.112017939505104, 0.160461548309117, 0.0987729881631583, 0.0321210987292377
#22, 0.0577214613120704, 0.000801910437562783, 0.39247642998454, 0.11866863489822, 0.159790834825377, 0.0773920928942557, 0.0270672930514227
#23, 0.055786925096743, 0.00100006734611935, 0.358770447298983, 0.111375940826352, 0.138247304842019, 0.0716574245343859, 0.0270056552372683
#24, 0.0564602377654174, 0.000993136186294763, 0.301752127396975, 0.11423232129835, 0.128612745144417, 0.0712319008294405, 0.0235498532111546
#25, 0.0504446098912295, 0.000909714726977382, 0.261699553955606, 0.100129391386688, 0.115779578958478, 0.0640759733933964, 0.0238410856944985
#26, 0.0504663935363925, 0.000564641984281744, 0.227817569318789, 0.0823375991998115, 0.113209975224223, 0.0599378234366941, 0.0197338784155846
#27, 0.0471613442364636, 0.000828026057616147, 0.199108581554628, 0.0882521064029871, 0.0978622832704917, 0.0560463485073205, 0.0206999088161368
#28, 0.0448714623094148, 0.000709453716331204, 0.182653389277497, 0.0716492556674497, 0.0865052065857683, 0.0467618123808605, 0.018769952117122
#29, 0.0380669199223352, 0.000349033405452546, 0.155528419074677, 0.0546185295834551, 0.0804658147350388, 0.0442561981042713, 0.0165095276193278
#30, 0.040112354694856, 0.000371559674882463, 0.142650571662011, 0.0415008145325747, 0.0800291516660897, 0.0417226116469616, 0.0153191009194545
#31, 0.0342964927484696, 0.000277741475828196, 0.123807966137442, 0.0364419342556024, 0.0933960171585218, 0.0419083914844028, 0.012100691117333
#32, 0.0294191841047593, 7.72329237597124e-05, 0.117886527774442, 0.0308191546186152, 0.0957060737114886, 0.0313481506380848, 0.0118155233988356
#33, 0.0271493530329174, 3.93590861467765e-05, 0.130553469895302, 0.0283670092892444, 0.070619854662787, 0.0294819358553141, 0.010007480850307
#34, 0.0256947996354428, 0.000114364137105728, 0.0903714322900665, 0.0240705565929769, 0.0492035609704945, 0.0226631598364518, 0.00946251840909861
#35, 0.0220809424111862, 0, 0.0779243069522152, 0.0222017426252719, 0.0451876964764117, 0.0192832292562751, 0.0117319781688071
#36, 0.018982961511017, 3.37894041448742e-05, 0.0635134355112043, 0.0212863344455815, 0.0534990235010727, 0.0147573056615293, 0.0066214855052838
#37, 0.0180878517279557, 6.57222476224476e-05, 0.0590588038460828, 0.0227788854513802, 0.0434383212449698, 0.0123337513664348, 0.00497669652476647
#38, 0.0168032355168947, 3.16853020552666e-05, 0.0513202876726397, 0.0233108519679174, 0.0386012380823843, 0.0107445354352254, 0.00406549654925525
#39, 0.0170903835667706, 0, 0.0437215086320887, 0.0154665118364382, 0.0352201935658073, 0.0069430418128603, 0.00358910308202587
#40, 0.0133392646238449, 0, 0.0355462056189853, 0.0127821726529436, 0.0318141473655773, 0.00700406077345892, 0.00285551407701975
#41, 0.0102501952148788, 0, 0.0305310164030502, 0.0105687810253876, 0.0251291674854718, 0.00587267270280582, 0.00257368816772349
#42, 0.00865627599664546, 0, 0.0253603711739063, 0.00647382704687782, 0.0196347380759507, 0.00443891278480501, 0.00220175718070757
#43, 0.00802504536976319, 0, 0.0272352499064578, 0.00557500414248193, 0.0140545355636004, 0.00410708350820278, 0.00159874627596828
#44, 0.0067202545327842, 0, 0.0200788273875691, 0.00577996844015194, 0.00924307293822366, 0.00315058345240942, 0.0039925956003859
#45, 0.00473794282295159, 0, 0.0132588136615952, 0.00271627202697219, 0.00667408805752399, 0.00359875719749583, 0.00109970276859783
#46, 0.00318264006659815, 0, 0.00824993675192889, 0.00175383097704347, 0.0043014035247136, 0.00207179793399652, 0.000847086747133769
#47, 0.00232379510190481, 0, 0.00584111117146171, 0.00103249527244154, 0.00263903910321248, 0.00156074866764419, 0.000817629317879263
#48, 0.00263062269485405, 0, 0.00570434453563722, 0.00105316498120416, 0.00126085223451954, 0.00063655276746186, 0.000437405693216063
#49, 0.00193540261030549, 0, 0.00419718858592245, 0.000508326310706953, 0.000776289900354032, 0.000787305493646684, 0.000547066543297963
#50, 0.00101727147496967, 0, 0.00339478306551505, 0.000433321259748002, 0.000341235850649883, 0.000577637908952849, 0.000336656334337208


#sed -e 's/ /\t/g' table | sed -e 's/[,]//g' > table_oasisia_Feb2021

#piechart has to look like this:
#name percentage #add this line after awk
#Simple_repeat 82544167
#SINE 6637491
#Retro 26637111
#LINE 78461307
#LTR 34977040
#DNA 149818831
#nonLTR 381142
#unclear 25896914
#Unmasked 402591585

#piechart_with_percentage
#genome_size=807945588
#awk '{ print $1, 100*$2/807945588 }' pie > pie_oasisia_Feb2021
